# cloudbuild.yaml
options:
  logging: "CLOUD_LOGGING_ONLY"

steps:
  # Step 1: Build the Docker image for the backend
  - name: 'gcr.io/cloud-builders/docker'
    id: 'Build Docker image'
    args: [
      'build', 
      '-t', 
      'us-central1-docker.pkg.dev/$PROJECT_ID/$_REPO_NAME/$_SERVICE_NAME:latest', 
      '-f', 'functions/Dockerfile',  # Path to the Dockerfile
      'functions'  # Build context where source files are
    ]

  # Step 2: Push the Docker image to Google Artifact Registry
  - name: 'gcr.io/cloud-builders/docker'
    id: 'Push Docker image'
    args: [
      'push', 
      'us-central1-docker.pkg.dev/$PROJECT_ID/$_REPO_NAME/$_SERVICE_NAME:latest'
    ]

  # Step 3: Deploy the image to Cloud Run
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'Deploy to Cloud Run'
    entrypoint: 'bash'
    args: 
      - '-c'
      - |
        gcloud run deploy $_SERVICE_NAME \
          --image us-central1-docker.pkg.dev/$PROJECT_ID/$_REPO_NAME/$_SERVICE_NAME:latest \
          --platform managed \
          --region $_REGION \
          --service-account $_SERVICE_ACCOUNT \
          --allow-unauthenticated

substitutions:
  _PROJECT_ID: "$PROJECT_ID"
  _SERVICE_NAME: "littlefinger-backend"
  _REPO_NAME: "littlefinger-backend-repo"
  _REGION: "us-central1"
  _SERVICE_ACCOUNT: "saib-ai-playground-sa@saib-ai-playground.iam.gserviceaccount.com"

timeout: '1200s'
